#!/bin/bash

# pkgsearch: Search package info ONLY if NOT installed
# Supports: apt, dnf/yum, pacman, zypper, apk

set -euo pipefail

if [ $# -eq 0 ]; then
    echo "Usage: pkgsearch <package_name>"
    echo "Shows dependency info ONLY if the package is NOT installed."
    exit 1
fi

PKG="$1"

# Helper: Check if package is installed
is_installed() {
    case "$1" in
        apt)
            dpkg -l "$PKG" &>/dev/null
            ;;
        dnf|yum)
            rpm -q "$PKG" &>/dev/null
            ;;
        pacman)
            pacman -Q "$PKG" &>/dev/null
            ;;
        zypper)
            rpm -q "$PKG" &>/dev/null
            ;;
        apk)
            apk info "$PKG" &>/dev/null
            ;;
        *)
            return 1
            ;;
    esac
}

# Detect package manager and act
if command -v apt >/dev/null 2>&1; then
    if is_installed apt; then exit 0; fi
    echo "ðŸ” [APT] Info for NOT-INSTALLED package: $PKG"
    echo -e "\nðŸ“¦ Dependencies:"
    apt show "$PKG" 2>/dev/null | grep -E '^(Depends|Recommends):' | head -n 5 || echo "  (none or not found)"
    echo -e "\nâ†©ï¸ Reverse deps (what needs it):"
    apt rdepends "$PKG" 2>/dev/null | tail -n +2 | head -n 10 | sed 's/^/  /' || echo "  (none found)"

elif command -v dnf >/dev/null 2>&1; then
    if is_installed dnf; then exit 0; fi
    echo "ðŸ” [DNF] Info for NOT-INSTALLED package: $PKG"
    echo -e "\nðŸ“¦ Dependencies:"
    dnf deplist "$PKG" 2>/dev/null | grep 'dependency:' | head -n 8 | sed 's/^[[:space:]]*/  /' || echo "  (none or not found)"
    echo -e "\nâ†©ï¸ Reverse deps:"
    dnf repoquery --whatrequires "$PKG" 2>/dev/null | head -n 10 | sed 's/^/  /' || echo "  (none found)"

elif command -v yum >/dev/null 2>&1; then
    if is_installed yum; then exit 0; fi
    echo "ðŸ” [YUM] Info for NOT-INSTALLED package: $PKG"
    echo -e "\nðŸ“¦ Dependencies:"
    yum deplist "$PKG" 2>/dev/null | grep 'dependency:' | head -n 8 | sed 's/^[[:space:]]*/  /' || echo "  (none or not found)"
    echo -e "\nâ†©ï¸ Reverse deps:"
    yum whatrequires "$PKG" 2>/dev/null | head -n 10 | sed 's/^/  /' || echo "  (none found)"

elif command -v pacman >/dev/null 2>&1; then
    if is_installed pacman; then exit 0; fi
    echo "ðŸ” [Pacman] Info for NOT-INSTALLED package: $PKG"
    echo -e "\nðŸ“¦ Dependencies:"
    pacman -Si "$PKG" 2>/dev/null | grep 'Depends On' | sed 's/Depends On[[:space:]]*:[[:space:]]*/  /' || echo "  (none or not found)"
    echo -e "\nâ†©ï¸ Reverse deps:"
    # Note: pactree -r may not work for uninstalled; fallback to pkgfile if available
    if command -v pkgfile >/dev/null; then
        pkgfile -r "$PKG" 2>/dev/null | head -n 10 | sed 's/^/  /' || echo "  (none found)"
    else
        echo "  (install 'pkgfile' for reverse deps on Arch)"
    fi

elif command -v zypper >/dev/null 2>&1; then
    if is_installed zypper; then exit 0; fi
    echo "ðŸ” [Zypper] Info for NOT-INSTALLED package: $PKG"
    echo -e "\nðŸ“¦ Dependencies:"
    zypper info "$PKG" 2>/dev/null | grep -A5 'Requires:' | tail -n +2 | head -n 6 | sed 's/^[[:space:]]*/  /' || echo "  (none or not found)"
    echo -e "\nâ†©ï¸ Reverse deps:"
    zypper search --requires "$PKG" 2>/dev/null | tail -n +5 | head -n 10 | awk '{print "  "$1}' || echo "  (none found)"

elif command -v apk >/dev/null 2>&1; then
    if is_installed apk; then exit 0; fi
    echo "ðŸ” [APK] Info for NOT-INSTALLED package: $PKG"
    echo -e "\nðŸ“¦ Dependencies:"
    apk info -R "$PKG" 2>/dev/null | tail -n +2 | sed 's/^/  /' || echo "  (none or not found)"
    echo -e "\nâ†©ï¸ Reverse deps:"
    echo "  (APK does not support reverse deps easily)"

else
    echo "âŒ Unsupported package manager." >&2
    exit 1
fi

echo ""
